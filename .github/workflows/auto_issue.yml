name: Auto Issue on PR Open
on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  issues: write
  contents: read

jobs:
  detect-template:
    runs-on: ubuntu-latest
    outputs:
      template: ${{ steps.detect.outputs.template }}
    steps:
      - name: Detect template type
        id: detect
        run: |
          title="${{ github.event.pull_request.title }}"
          template="custom.md"
          if [[ "$title" =~ [bB][uU][gG] ]]; then
            template="bug_report.md"
          elif [[ "$title" =~ [fF][eE][aA][tT][uU][rR][eE] ]]; then
            template="feature_request.md"
          fi
          echo "template=$template" >> $GITHUB_OUTPUT

  create-issue:
    needs: detect-template
    runs-on: ubuntu-latest
    steps:
      # 1) 여기서는 기본(base) repo를 그대로 사용합니다.
      - name: Check out base repo (upstream)
        uses: actions/checkout@v3
        # ref: '${{ github.event.pull_request.base.ref }}'  # 보통 develop

      # 2) 템플릿 파일이 이 워크스페이스에 있어야 읽힙니다.
      - name: List ISSUE_TEMPLATE dir for debug
        run: ls -R .github/ISSUE_TEMPLATE

      - name: Create Issue from selected template
        uses: peter-evans/create-issue-from-file@v4
        with:
          content-filepath: .github/ISSUE_TEMPLATE/${{ needs.detect-template.outputs.template }}
          title: "[Auto] PR #${{ github.event.pull_request.number }} 검증"
          labels: auto-generated
          assignees: ${{ github.event.pull_request.user.login }}
